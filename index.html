<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Queue Management System</title>
    <style>
        /* CSS styles for layout */
        .container {
            display: contents;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1500px;
            margin: 1px auto;
            padding: 5px;
        }
        .form-container {
            display: block;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            max-width: 1000px;
            margin-bottom: 0px;
        }
        .form-container > * {
            flex: 2;
            margin-right: 5px;
            font-size: 16px;
            padding: 10px;
            margin-bottom: 0px;
        }
        .input-field {
            width: 90%;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .control-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .control-buttons button {
            padding: 7px 7px;
            font-size: 14px;
            cursor: pointer;
            font-weight: bold;
            flex-grow: 1;
        }
        .queue-container {
            display: flex;
            justify-content: left;
            width: 800px;
            max-width: 1000px;
            margin-top: 10px;
        }
        .queue-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 2000px;
        }
        .queue {
            display: block;
            border: 2px solid #ccc;
            padding: 0px;
            width: 220px;
            height: 200px;
            overflow-y: auto;
            font-size: 18px;
            font-weight: bold;
        }
        .timer-container {
            display: flex;
            flex-wrap: nowrap;
            justify-content: space-between;
            align-items: center;
            width: 200px;
            padding: 5px 0;
        }
        .timer {
            text-align: left;
            width: 100%;
            font-size: 18px;
            font-weight: bold;
        }
        .current-name {
            text-align: right;
            font-size: 16px;
            font-weight: bold;
            white-space: nowrap; /* Ensure the name doesn't wrap to the next line */
        }
        .timer-buttons {
            display: flex;
            justify-content: center;
            width: 150px;
        }
        button {
            padding: 5px 10px;
            font-size: 18px;
            cursor: pointer;
            font-weight: bold;
        }
        .timer-red {
            color: red;
        }
        .login-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 50px;
        }
        .login-container input {
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
            width: 200px;
        }
        .login-container button {
            padding: 10px;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <!-- Add a login container -->
    <div class="login-container" id="login-container">
        <h2>Login</h2>
        <input type="email" id="email" placeholder="Email" >
        <input type="password" id="password" placeholder="Password">
        <button onclick="login()">Login</button>
    </div>

    <!-- Your existing HTML for the app -->
    <div class="container" id="app-container" style="display:none;">
        <div class="queue-container">
            <div class="queue-wrapper">
                <h2 id="spymasterHeader">Spymaster</h2>
                <input type="text" id="spymasterNameInput" class="input-field" placeholder="Enter Name">
                <div class="control-buttons">
                    <button onclick="enqueueSpymaster()">IN</button>
                    <button onclick="dequeueSpymaster()">OUT FIRST</button>
                    <button onclick="removeLastSpymaster()">OUT LAST</button>
                </div>
                <div class="queue" id="spymasterQueue"></div>
                <div class="timer-container">
                    <div class="timer" id="spymasterTimer">Time Left: 5:00<br>For:</div>
                </div>
                <div class="timer-buttons">
                    <button onclick="startTimerSpymaster()">Start</button>
                    <button onclick="pauseTimerSpymaster()">Pause</button>
                    <button onclick="resetTimerSpymaster()">Reset</button>
                </div>
            </div>
            <div class="queue-wrapper">
                <h2 id="chiefWarderHeader">Chief Warder</h2>
                <input type="text" id="chiefWarderNameInput" class="input-field" placeholder="Enter Name">
                <div class="control-buttons">
                    <button onclick="enqueueChiefWarder()">IN</button>
                    <button onclick="dequeueChiefWarder()">OUT FIRST</button>
                    <button onclick="removeLastChiefWarder()">OUT LAST</button>
                </div>
                <div class="queue" id="chiefWarderQueue"></div>
                <div class="timer-container">
                    <div class="timer" id="chiefWarderTimer">Time Left: 5:00<br>For:</div>
                </div>
                <div class="timer-buttons">
                    <button onclick="startTimerChiefWarder()">Start</button>
                    <button onclick="pauseTimerChiefWarder()">Pause</button>
                    <button onclick="resetTimerChiefWarder()">Reset</button>
                </div>
            </div>
            <div class="queue-wrapper">
                <h2 id="archmageHeader">Archmage</h2>
                <input type="text" id="archmageNameInput" class="input-field" placeholder="Enter Name">
                <div class="control-buttons">
                    <button onclick="enqueueArchmage()">IN</button>
                    <button onclick="dequeueArchmage()">OUT FIRST</button>
                    <button onclick="removeLastArchmage()">OUT LAST</button>
                </div>
                <div class="queue" id="archmageQueue"></div>
                <div class="timer-container">
                    <div class="timer" id="archmageTimer">Time Left: 5:00<br>For:</div>
                </div>
                <div class="timer-buttons">
                    <button onclick="startTimerArchmage()">Start</button>
                    <button onclick="pauseTimerArchmage()">Pause</button>
                    <button onclick="resetTimerArchmage()">Reset</button>
                </div>
            </div>
            <div class="queue-wrapper">
                <h2 id="highScholarHeader">High Scholar</h2>
                <input type="text" id="highScholarNameInput" class="input-field" placeholder="Enter Name">
                <div class="control-buttons">
                    <button onclick="enqueueHighScholar()">IN</button>
                    <button onclick="dequeueHighScholar()">OUT FIRST</button>
                    <button onclick="removeLastHighScholar()">OUT LAST</button>
                </div>
                <div class="queue" id="highScholarQueue"></div>
                <div class="timer-container">
                    <div class="timer" id="highScholarTimer">Time Left: 5:00<br>For:</div>
                </div>
                <div class="timer-buttons">
                    <button onclick="startTimerHighScholar()">Start</button>
                    <button onclick="pauseTimerHighScholar()">Pause</button>
                    <button onclick="resetTimerHighScholar()">Reset</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>

    <script>
        // Your Firebase configuration
        var firebaseConfig = {
            apiKey: "AIzaSyBjxB9IJ85mGG3fkDJExfoUi8VTSnghk1U",
            authDomain: "title-givers.firebaseapp.com",
            databaseURL: "https://title-givers-default-rtdb.firebaseio.com",
            projectId: "title-givers",
            storageBucket: "title-givers.appspot.com",
            messagingSenderId: "183878674615",
            appId: "1:183878674615:web:d3c9c14deb2d7e4cd64532",
            measurementId: "G-DK3RGZM76M"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    document.getElementById('login-container').style.display = 'none';
                    document.getElementById('app-container').style.display = 'block';
                })
                .catch((error) => {
                    alert(error.message);
                });
        }

        let queues = {
            spymaster: [],
            chiefWarder: [],
            archmage: [],
            highScholar: []
        };

        let timers = {
            spymaster: null,
            chiefWarder: null,
            archmage: null,
            highScholar: null
        };

        let timerEndTimes = {
            spymaster: null,
            chiefWarder: null,
            archmage: null,
            highScholar: null
        };

        let timerRemainingTimes = {
            spymaster: 300,
            chiefWarder: 300,
            archmage: 300,
            highScholar: 300
        };

        function updateQueueSpymaster(snapshot) {
            const data = snapshot.val();
            if (data) {
                queues.spymaster = data.queue || [];
                timerRemainingTimes.spymaster = data.timerRemaining || 300;
                updateQueue('spymaster');
                updateTimerDisplay('spymaster');
            }
        }

        function updateQueueChiefWarder(snapshot) {
            const data = snapshot.val();
            if (data) {
                queues.chiefWarder = data.queue || [];
                timerRemainingTimes.chiefWarder = data.timerRemaining || 300;
                updateQueue('chiefWarder');
                updateTimerDisplay('chiefWarder');
            }
        }

        function updateQueueArchmage(snapshot) {
            const data = snapshot.val();
            if (data) {
                queues.archmage = data.queue || [];
                timerRemainingTimes.archmage = data.timerRemaining || 300;
                updateQueue('archmage');
                updateTimerDisplay('archmage');
            }
        }

        function updateQueueHighScholar(snapshot) {
            const data = snapshot.val();
            if (data) {
                queues.highScholar = data.queue || [];
                timerRemainingTimes.highScholar = data.timerRemaining || 300;
                updateQueue('highScholar');
                updateTimerDisplay('highScholar');
            }
        }

        function saveQueueToFirebase(queue) {
            database.ref(`queues/${queue}`).set({
                queue: queues[queue],
                timerRemaining: timerRemainingTimes[queue]
            });
        }

        function initializeQueueListeners() {
            database.ref(`queues/spymaster`).on('value', updateQueueSpymaster);
            database.ref(`queues/chiefWarder`).on('value', updateQueueChiefWarder);
            database.ref(`queues/archmage`).on('value', updateQueueArchmage);
            database.ref(`queues/highScholar`).on('value', updateQueueHighScholar);

            database.ref(`timers/spymaster`).on('value', (snapshot) => updateTimerStateFromFirebase('spymaster', snapshot.val()));
            database.ref(`timers/chiefWarder`).on('value', (snapshot) => updateTimerStateFromFirebase('chiefWarder', snapshot.val()));
            database.ref(`timers/archmage`).on('value', (snapshot) => updateTimerStateFromFirebase('archmage', snapshot.val()));
            database.ref(`timers/highScholar`).on('value', (snapshot) => updateTimerStateFromFirebase('highScholar', snapshot.val()));
        }

        initializeQueueListeners();

        function enqueueSpymaster() {
            enqueue('spymaster');
        }

        function enqueueChiefWarder() {
            enqueue('chiefWarder');
        }

        function enqueueArchmage() {
            enqueue('archmage');
        }

        function enqueueHighScholar() {
            enqueue('highScholar');
        }

        function dequeueSpymaster() {
            dequeue('spymaster');
        }

        function dequeueChiefWarder() {
            dequeue('chiefWarder');
        }

        function dequeueArchmage() {
            dequeue('archmage');
        }

        function dequeueHighScholar() {
            dequeue('highScholar');
        }

        function removeLastSpymaster() {
            removeLast('spymaster');
        }

        function removeLastChiefWarder() {
            removeLast('chiefWarder');
        }

        function removeLastArchmage() {
            removeLast('archmage');
        }

        function removeLastHighScholar() {
            removeLast('highScholar');
        }

        function updateQueue(queue) {
            document.getElementById(`${queue}Queue`).innerHTML = queues[queue].map((item, index) => `<div>${index + 1}- ${item}</div>`).join('');
            updateCurrentName(queue);
        }

        function startTimerSpymaster() {
            startTimer('spymaster');
        }

        function startTimerChiefWarder() {
            startTimer('chiefWarder');
        }

        function startTimerArchmage() {
            startTimer('archmage');
        }

        function startTimerHighScholar() {
            startTimer('highScholar');
        }

        function pauseTimerSpymaster() {
            pauseTimer('spymaster');
        }

        function pauseTimerChiefWarder() {
            pauseTimer('chiefWarder');
        }

        function pauseTimerArchmage() {
            pauseTimer('archmage');
        }

        function pauseTimerHighScholar() {
            pauseTimer('highScholar');
        }

        function resetTimerSpymaster() {
            resetTimer('spymaster');
        }

        function resetTimerChiefWarder() {
            resetTimer('chiefWarder');
        }

        function resetTimerArchmage() {
            resetTimer('archmage');
        }

        function resetTimerHighScholar() {
            resetTimer('highScholar');
        }

        function enqueue(queue) {
            let nameInput = document.getElementById(`${queue}NameInput`);
            let name = nameInput.value.trim();
            if (name !== '') {
                queues[queue].push(name);
                nameInput.value = '';
                updateQueue(queue);
                saveQueueToFirebase(queue);
            }
        }

        function dequeue(queue) {
            if (queues[queue].length > 0) {
                queues[queue].shift();
                updateQueue(queue);
                saveQueueToFirebase(queue);
                resetTimer(queue);
            }
        }

        function removeLast(queue) {
            if (queues[queue].length > 0) {
                queues[queue].pop();
                updateQueue(queue);
                saveQueueToFirebase(queue);
            }
        }

        function startTimer(queue) {
            if (!timers[queue]) {
                let startTime = Date.now();
                timerEndTimes[queue] = startTime + timerRemainingTimes[queue] * 1000;
                saveTimerStateToFirebase(queue, 'start');

                function updateTimer() {
                    let currentTime = Date.now();
                    let remainingTime = Math.floor((timerEndTimes[queue] - currentTime) / 1000);

                    if (remainingTime <= 0) {
                        remainingTime = 0;
                        document.getElementById(`${queue}Timer`).classList.add('timer-red');
                        playSound();
                        saveTimerStateToFirebase(queue, 'end');
                    } else {
                        timers[queue] = requestAnimationFrame(updateTimer);
                    }

                    timerRemainingTimes[queue] = remainingTime;
                    saveQueueToFirebase(queue);

                    let currentName = queues[queue].length > 0 ? queues[queue][0] : '';
                    document.getElementById(`${queue}Timer`).innerText = `Time Left: ${formatTime(remainingTime)}\n For: ${currentName}`;
                }

                timers[queue] = requestAnimationFrame(updateTimer);
            }
        }

        function pauseTimer(queue) {
            if (timers[queue]) {
                cancelAnimationFrame(timers[queue]);
                timers[queue] = null;
                saveTimerStateToFirebase(queue, 'pause');
                saveQueueToFirebase(queue);
            }
        }

        function resetTimer(queue) {
            if (timers[queue]) {
                cancelAnimationFrame(timers[queue]);
                timers[queue] = null;
            }
            timerRemainingTimes[queue] = 300;
            document.getElementById(`${queue}Timer`).innerText = `Time Left: 5:00 `;
            document.getElementById(`${queue}Timer`).classList.remove('timer-red');
            updateCurrentName(queue);
            saveTimerStateToFirebase(queue, 'reset');
            saveQueueToFirebase(queue);
        }

        function saveTimerStateToFirebase(queue, action) {
            database.ref(`timers/${queue}`).set({
                endTime: timerEndTimes[queue] || null,
                remainingTime: timerRemainingTimes[queue],
                action: action
            });
        }

        function updateTimerStateFromFirebase(queue, data) {
            if (data) {
                timerEndTimes[queue] = data.endTime || Date.now() + timerRemainingTimes[queue] * 1000;
                timerRemainingTimes[queue] = data.remainingTime || 300;

                switch (data.action) {
                    case 'start':
                        startTimer(queue);
                        break;
                    case 'pause':
                        pauseTimer(queue);
                        break;
                    case 'reset':
                        resetTimer(queue);
                        break;
                    case 'end':
                        document.getElementById(`${queue}Timer`).classList.add('timer-red');
                        break;
                }
            }
        }

        function updateCurrentName(queue) {
            let currentName = queues[queue].length > 0 ? queues[queue][0] : '';
            document.getElementById(`${queue}Timer`).innerHTML = `Time Left: 5:00<br>For: ${currentName}`;
        }

        function formatTime(seconds) {
            let minutes = Math.floor(seconds / 60);
            let secs = seconds % 60;
            return `${minutes}:${secs.toString().padStart(2, '0')}`;
        }

        function playSound() {
            var audio = new Audio('sounds/beep.mp3');
            audio.play().catch(function(error) {
                console.error('Audio playback failed:', error);
            });
        }

        function updateTimerDisplay(queue) {
            if (timerRemainingTimes[queue] < 300) {
                startTimer(queue);
            }
        }

        // Initial update of queues on page load
        ['spymaster', 'chiefWarder', 'archmage', 'highScholar'].forEach(updateQueue);

    </script>
</body>
</html>
